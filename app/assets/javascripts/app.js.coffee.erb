
app = angular.module 'envelopes', ['ngRoute']
  .config ($routeProvider, $locationProvider) ->

    if window.history && window.history.pushState
      $locationProvider.html5Mode true


app.factory 'envelopeService', ($http) ->

  envelopes = null
  getEnvelopes = (callback) ->
    callback envelopes if envelopes

    $http.get('/envelopes.json').success (data) ->
      organized_envelopes = data[""]
      stack = data[""].slice()

      while stack.length
        env = stack.pop()
        if data[env.id]
          stack = stack.concat data[env.id]
          env.children = data[env.id]

      envelopes = organized_envelopes
      callback organized_envelopes

  all: getEnvelopes



app.directive 'leftPanel', ->
  templateUrl: '<%= asset_path('partials/left_panel.html') %>'
  controller: ($scope, envelopeService) ->
    envelopeService.all (env) ->
      $scope.envelopes = env

