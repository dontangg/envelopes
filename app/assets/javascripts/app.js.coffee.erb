# TODO:
# * Handle errors
# * Handle authorization
# * Organize CSS better

app = angular.module 'envelopes', ['ngRoute']
  .config ($routeProvider, $locationProvider) ->

    if window.history && window.history.pushState
      $locationProvider.html5Mode true

    $routeProvider
      .when "/envelopes/:envelopeId",
        templateUrl: '<%= asset_path('partials/envelope.html') %>'
        controller: 'EnvelopeCtrl'
        resolve:
          data: envCtrl.loadData

app.run ['$rootScope', ($rootScope) ->
  $rootScope.$on '$routeChangeStart', ->
    $rootScope.loading = true
  $rootScope.$on '$routeChangeSuccess', ->
    $rootScope.loading = false
  $rootScope.$on '$routeChangeError', (e, curr, prev, rejection) ->
    $rootScope.loading = false
    console.log 'route error', e, curr, prev, rejection
]

app.filter 'envelopeUrl', ->
  (envelope) ->
    name = envelope.name.toLowerCase().replace " ", "-"
    name = name.replace /[^a-zA-Z-]/, ""
    "/envelopes/#{envelope.id}-#{name}"




app.factory 'EnvelopeService', ['$http', '$q', ($http, $q) ->

  envelopesPromise = null
  getEnvelopes = ->
    return envelopesPromise if envelopesPromise

    envelopesPromise = $http.get('/envelopes.json')
      .then (response) ->
        data = response.data
        organized_envelopes = data[""]
        stack = data[""].slice() # Make a copy of the root-level array

        while stack.length
          env = stack.pop()
          if data[env.id]
            stack = stack.concat data[env.id]
            env.children = data[env.id]

        organized_envelopes

  findById = (id) ->
    getEnvelopes().then (envelopes) ->
      $q (resolve, reject) ->
        id = parseInt id
        stack = envelopes.slice()
        while stack.length
          envelope = stack.pop()
          if envelope.id == id
            resolve envelope
            return
          stack = stack.concat envelope.children if envelope.children

        reject "Unable to find envelope id: #{id}"

  all: getEnvelopes
  find: findById
]

app.factory 'TransactionService', ['$http', ($http) ->

  find: (options) ->
    envelopeId = options.envelopeId
    options =
      params:
        show_transfers: options.showTransfers

    $http.get("/envelopes/#{envelopeId}/transactions.json", options)
      .then (response) ->
        response.data
]


app.directive 'leftPanel', ->
  templateUrl: '<%= asset_path('partials/left_panel.html') %>'
  controller: ['$scope', 'EnvelopeService', ($scope, EnvelopeService) ->
    EnvelopeService.all().then (envelopes) ->
      $scope.envelopes = envelopes
  ]



envCtrl = app.controller 'EnvelopeCtrl', ['$scope', '$routeParams', '$rootScope', '$injector', 'EnvelopeService', 'data',
  ($scope, $routeParams, $rootScope, $injector, EnvelopeService, data) ->
    EnvelopeService.find($routeParams.envelopeId).then (envelope) ->
      parentId1 = envelope.parent_envelope_id
      if parentId1
        EnvelopeService.find(parentId1).then (parentEnvelope1) ->
          parentId2 = parentEnvelope1.parent_envelope_id
          if parentId2
            EnvelopeService.find(parentId2).then (parentEnvelope2) ->
              $scope.fullParentName = "#{parentEnvelope2.name}: #{parentEnvelope1.name}"
          else
            $scope.fullParentName = parentEnvelope1.name

      $scope.envelope = envelope
      $scope.transactions = data
      $scope.toggleTransfers = ->
        # TODO: Show progress & handle failures
        $rootScope.showTransfers = !$rootScope.showTransfers
        $scope.txnsLoading = true
        $injector.invoke(envCtrl.loadData)
          .then (data) ->
            $scope.transactions = data
          .finally ->
            $scope.txnsLoading = false
]

envCtrl.loadData = ['$route', '$rootScope', 'TransactionService', ($route, $rootScope, TransactionService) ->
  envelopeId = $route.current.params.envelopeId
  TransactionService.find
    envelopeId: envelopeId
    showTransfers: $rootScope.showTransfers
]

